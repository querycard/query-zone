{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>{{ product.name }} - Query Zone</title>
{% endblock meta %}

{% block content %}
<div class="bg-gray-50 w-full min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Back Navigation -->
        <div class="mb-6">
            <a href="{% url 'main:show_main' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
                ← Back to Product
            </a>
        </div>
        
        <!-- Loading State -->
        <div id="loading-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p class="text-gray-600 mt-3">Loading product detail...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
            <div class="w-16 h-16 mx-auto mb-4">
                <div class="text-red-500 text-5xl">⚠️</div>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load product</h3>
            <p class="text-gray-500">Please try again later.</p>
        </div>
        
        <!-- Product Content -->
        <div id="product-content" class="bg-white rounded-lg border border-gray-200 overflow-hidden hidden">
            
            <!-- Header -->
            <div class="p-6 sm:p-8">
                <div id="badges-container" class="flex flex-wrap items-center gap-2 mb-4"></div>
                
                <h1 id="product-name" class="text-3xl sm:text-4xl font-bold text-gray-900 leading-tight mb-2"></h1>
                <p id="product-brand" class="text-gray-700 text-lg"></p>

                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-4 mt-3">
                    <time id="product-date"></time>
                    <span id="product-views"></span>
                </div>
            </div>

            <!-- Featured Image -->
            <div id="featured-image-container" class="px-6 sm:px-8 hidden">
                <img id="featured-image" 
                     src="" 
                     alt="" 
                     class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg">
            </div>

            <!-- Content -->
            <div class="p-6 sm:p-8">
                <div class="prose prose-lg max-w-none">
                    <div id="product-content-text" class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg"></div>
                </div>
            </div>

            <!-- Additional Fields -->
            <div class="px-6 sm:px-8 pb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-800">

                    <p><strong>Price:</strong> <span id="product-price"></span></p>
                    <p><strong>Stock:</strong> <span id="product-stock"></span></p>

                    <p><strong>Gender:</strong> <span id="product-gender"></span></p>
                    <p><strong>Bonus Points:</strong> <span id="product-bonus"></span></p>
                </div>
            </div>

            <!-- Author Info -->
            <div class="border-t border-gray-200 p-6 sm:p-8 bg-gray-50">
                <p id="product-author" class="font-medium text-gray-900">Author: Loading...</p>
            </div>
        </div>
    </div>
</div>

<script>
// FIX TERPENTING — URL HARUS AMAN
const PRODUCT_ID = "{{ product.id }}";

console.log("DEBUG URL =", "{% url 'main:show_json_by_id' product_id=product.id %}");
const PRODUCT_DETAIL_ENDPOINT =
    "{% url 'main:show_json_by_id' product_id=product.id %}";


// DOM
const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const content = document.getElementById('product-content');

const badges = document.getElementById('badges-container');
const nameEl = document.getElementById('product-name');
const brandEl = document.getElementById('product-brand');
const dateEl = document.getElementById('product-date');
const viewsEl = document.getElementById('product-views');

const featuredImageContainer = document.getElementById('featured-image-container');
const featuredImage = document.getElementById('featured-image');

const descEl = document.getElementById('product-content-text');

const priceEl = document.getElementById('product-price');
const stockEl = document.getElementById('product-stock');
const genderEl = document.getElementById('product-gender');
const bonusEl = document.getElementById('product-bonus');

const authorEl = document.getElementById('product-author');

// Helpers
function showState(state) {
    loadingState.classList.toggle("hidden", state !== "loading");
    errorState.classList.toggle("hidden", state !== "error");
    content.classList.toggle("hidden", state !== "ready");
}

function getCategoryLabel(cat) {
    const map = {
        shoes: "Shoes",
        jersey: "Jersey",
        shorts: "Shorts",
        jacket: "Jacket",
        accessory: "Accessory",
        ball: "Ball",
        exclusive: "Exclusive",
    };
    return map[cat] || cat;
}

// Render
function renderProduct(p) {
    nameEl.textContent = p.name;
    brandEl.textContent = "Brand: " + (p.brand || "Unknown");

    badges.innerHTML = "";

    const cat = document.createElement("span");
    cat.className = "inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-green-600 text-white";
    cat.textContent = getCategoryLabel(p.category);
    badges.appendChild(cat);

    if (p.is_featured) {
        const f = document.createElement("span");
        f.className = "inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800";
        f.textContent = "Featured";
        badges.appendChild(f);
    }

    if (p.product_views > 20) {
        const h = document.createElement("span");
        h.className = "inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-red-100 text-red-800";
        h.textContent = "Hot";
        badges.appendChild(h);
    }

    const formatted = new Date(p.created_at).toLocaleString("en-US", {
        year: "numeric", month: "long", day: "numeric",
        hour: "2-digit", minute: "2-digit"
    });
    dateEl.textContent = formatted;
    viewsEl.textContent = `${p.product_views} views`;

    if (p.thumbnail) {
        featuredImage.src = p.thumbnail;
        featuredImage.alt = p.name;
        featuredImageContainer.classList.remove("hidden");
    }

    descEl.textContent = p.description;

    priceEl.textContent = "Rp " + p.price.toLocaleString();
    stockEl.textContent = p.stock;
    genderEl.textContent = p.gender;
    bonusEl.textContent = p.bonus_points + " pts";

    authorEl.textContent = "Author: " + (p.user_username || "Anonymous");
}

// Load
async function loadDetail() {
    try {
        showState("loading");

        const res = await fetch(PRODUCT_DETAIL_ENDPOINT);
        if (!res.ok) throw new Error();

        const data = await res.json();
        renderProduct(data);

        showState("ready");
    } catch {
        showState("error");
    }
}

loadDetail();
</script>

{% endblock content %}
